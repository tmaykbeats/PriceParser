# Мастер-план проекта PriceParser

## Цель проекта
PriceParser — это Python-инструмент для автоматического отслеживания цен продуктов на веб-сайтах, хранения истории цен, отправки уведомлений через Telegram и визуализации данных через веб-интерфейс на FastAPI. Проект расширен интеграцией с Product Inflation Tracker (PIT) для парсинга реальных цен продуктов с учётом размера упаковки и расчёта цены за единицу измерения, а также функциональностью управления корзинами покупок.

## Текущее состояние
Проект обладает работающим ядром:
- **Telegram-бот** на aiogram 2.21 с командами для подписки, отчётов, истории, управления корзинами и PIT.
- **Веб-интерфейс** на FastAPI с Jinja2-шаблонами, таблицей продуктов, фильтрацией, сортировкой и графиками истории цен.
- **Парсеры**: основной парсер (services/parser.py) для сайта scrapeme.live и парсер PIT (services/pit_integration/) с Selenium, конфигурируемыми магазинами.
- **База данных** SQLite через ORM Peewee с моделями Product, Subscription, PriceHistory, Basket, BasketItem.
- **Планировщик** на основе APScheduler (main.py) для периодического запуска парсеров и отправки уведомлений.
- **Уведомления** через Telegram и email (SMTP).
- **Корзина покупок**: создание, управление, расчёт общей стоимости с учётом количества и цены за единицу.
- **Тестирование**: набор тестов в директории tests/ с использованием pytest, pytest-asyncio, pytest-mock.

Большинство задач из планов интеграции уже выполнено.

## Завершённые задачи
1. **Подготовка** – изучение структур PIT и PP, копирование файлов PIT.
2. **Расширение моделей БД** – добавление полей unit_size, unit_type, price_per_unit, external_id, store в модель Product; создание модели PriceHistory; скрипт миграции (init_db.py).
3. **Интеграция парсеров PIT** – копирование модулей PIT, создание адаптера (services/pit_parser.py, services/pit_db.py), рефакторинг функций.
4. **Сохранение результатов в БД** – функция save_pit_results (services/pit_db.py), обновление цен и истории.
5. **Реализация функциональности «Корзина»** – модели Basket и BasketItem, команды бота (services/basket_handlers.py).
6. **Настройка и тестирование** – добавление зависимостей (requirements.txt), создание тестов (tests/test_basket.py, tests/test_pit_integration.py), ручной запуск парсера.

## Оставшиеся задачи
1. **Полная интеграция парсера PIT в планировщик** – проверить/добавить задачу в main.py для периодического запуска PIT-парсера.
2. **Доработка веб-интерфейса** – отображение полей PIT (unit_size, price_per_unit) и корзин в таблице продуктов.
3. **Конфигурация магазинов** – перенос текстового файла store_config.txt в БД для динамического управления через админку/бота.
4. **Конвертация валют** – реализация, если парсер собирает цены в разных валютах.
5. **Дополнительное тестирование** – проведение тестов в production-подобных условиях.
6. **Устранение противоречий документации** – обновление PLAN.md (или пометка как устаревшего) и согласование с INTEGRATION_PLAN.md.

## Архитектура
- **Backend**: FastAPI (web_app.py), асинхронный Telegram-бот (handlers.py, services/).
- **База данных**: SQLite + Peewee (models.py, init_db.py).
- **Парсинг**: requests/BeautifulSoup (основной), Selenium (PIT).
- **Планирование**: APScheduler (main.py).
- **Уведомления**: aiogram (Telegram), smtplib (email).
- **Фронтенд**: Jinja2-шаблоны (templates/), статика (static/).
- **Интеграция PIT**: модули в services/pit_integration/, адаптеры (pit_parser.py, pit_db.py).
- **Корзина**: модели Basket/BasketItem, обработчики basket_handlers.py.

## Планы
### Краткосрочные (ближайшие 1–2 недели)
1. Добавить задачу PIT-парсера в планировщик.
2. Расширить веб-интерфейс: добавить колонки unit_size, price_per_unit, кнопки управления корзиной.
3. Создать страницу управления конфигурацией магазинов.
4. Написать дополнительные тесты для покрытия edge-кейсов.

### Среднесрочные (1 месяц)
1. Реализовать конвертацию валют на основе актуальных курсов.
2. Добавить админ-панель для управления подписками и магазинами.
3. Оптимизировать парсинг PIT (кеширование, параллельный запуск).
4. Настроить мониторинг (логи, алерты).

### Долгосрочные (будущие версии)
1. Поддержка дополнительных платформ (мобильное приложение, расширение браузера).
2. Машинное обучение для прогнозирования цен.
3. Интеграция с другими сервисами (Google Sheets, Notion).
4. Масштабирование на распределённую архитектуру (PostgreSQL, Redis, Celery).

---
*Мастер-план создан на основе analysis_report.txt от 2026-02-16.*
